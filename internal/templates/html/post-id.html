<!DOCTYPE html>
<html lang="es-ES">

<head>
	{{- template "_head.html" . }}

	<meta property="og:title" content="{{ .Meta.Titulo }}" />
	<meta property="og:type" content="article" />
	<meta property="og:site_name" content="Vigo360" />
	<meta property="og:image" content="{{ .Meta.Miniatura }}" />
	<meta property="og:url" content="{{ .Meta.Canonica }}" />
	<meta property="og:locale" content="es_ES" />
	<meta property="og:description" content="{{ .Meta.Descripcion }}" />

	<meta property="article:published_time" content="{{ date3339 .Post.Fecha_publicacion }}" />
	<meta property="article:modified_time" content="{{ date3339 .Post.Fecha_actualizacion }}" />

	<link rel="alternate" type="application/atom+xml" href="/atom.xml" />

	<script type="application/ld+json">
		{
			"@context": "https://schema.org",
			"@type": "Article",
			"articleSection": [
				{{- $len := len .Post.Tags }}
				{{- range $i, $t := .Post.Tags}}
				{{- if $i}},{{ end }}
				"{{- $t.Nombre }}"
				{{- end }}
			],
			"publisher": {
				"@type": "Organization",
				"name": "Vigo360",
				"url": "https://vigo360.es",
				"email": "contacto@vigo360.es",
				"logo": {
					"@type": "ImageObject",
					"url": "https://vigo360.es/static/logo.webp",
					"width": 400,
					"height": 400
				}
			},
			"wordCount": {{ wordCount .Post.Contenido }},
			"author": {
				"@type": "Person",
				"name": "{{ .Post.Autor.Nombre }}",
				"url": "/autores/{{ .Post.Autor.Id }}",
				"jobTitle": "{{ .Post.Autor.Rol }}",
				"description": "{{ .Post.Autor.Biografia }}"
			},
			"creator": {
				"@type": "Person",
				"name": "{{ .Post.Autor.Nombre }}",
				"url": "/autores/{{ .Post.Autor.Id }}",
				"jobTitle": "{{ .Post.Autor.Rol }}",
				"description": "{{ .Post.Autor.Biografia }}"
			},
			"datePublished": "{{ date3339 .Post.Fecha_publicacion }}",
			"dateModified": "{{ date3339 .Post.Fecha_actualizacion }}",
			"headline": "{{ .Post.Titulo }}",
			"description": "{{ .Meta.Descripcion }}",
			"url": "/post/{{ .Post.Id }}",
			"image": {
				"@type": "ImageObject",
				"caption": "{{ .Post.Alt_portada }}",
				"license": "https://creativecommons.org/licenses/by-sa/4.0/",
				"acquireLicensePage": "/legal",
				"contentUrl": "/static/images/{{ .Post.Id}}.webp"
			},
			"license": "https://creativecommons.org/licenses/by-sa/4.0/",
			"inLanguage": "es-ES"
		}
	</script>

	<script src="https://hcaptcha.com/1/api.js" async defer></script>
</head>

<body>
	{{ template "_header.html" }}
	<main>
		<div id="post-main">
			<article>
				<figure id="post-thumbnail">
					<img width="1024" height="576" src="/static/images/{{ .Post.Id}}.webp"
						alt="{{ .Post.Alt_portada }}" />
					<figcaption>{{ .Post.Alt_portada }}</figcaption>
				</figure>

				<h2 id="post-title">{{ .Post.Titulo }}</h2>

				<p id="post-info">
					<a href="/autores/{{ .Post.Autor.Id }}">{{ .Post.Autor.Nombre }}</a> -
					{{ dateDayMonth .Post.Fecha_publicacion }} {{ if ne (dateDayMonth .Post.Fecha_actualizacion)
					(dateDayMonth .Post.Fecha_publicacion) }}(actualizado {{ dateDayMonth .Post.Fecha_actualizacion
					}}){{end}}
				</p>

				<div id="post-inner">
					{{ if ne .Post.Serie.Id "" }}
					<aside class="post-series">
						<h4>{{ .Post.Serie.Titulo }}</h4>
						<ul>
							{{ $postid := .Post.Id }}
							{{ range .Post.Serie.Publicaciones }}
							<li>
								{{ if eq .Id $postid }}
								<b>{{ .Titulo }}</b>
								{{ else }}
								<a href="/post/{{.Id}}">{{ .Titulo }}</a>
								{{end}}
							</li>
							{{ end }}
						</ul>
					</aside>
					{{ end }}
					{{ .Post.Contenido | markdown }}
				</div>
			</article>

			<div id="post-author-container">
				<a href="/autores/{{ .Post.Autor.Id }}">
					<div id="post-author-card">
						<img width="180" height="180" class="post-author-photo"
							src="/static/profile/{{ .Post.Autor.Id }}.jpg"
							alt="Fotografía de perfil de {{ .Post.Autor.Nombre }}" />
						<div class="post-author-info">
							<h3>{{ .Post.Autor.Nombre }}</h3>
							<span>{{ .Post.Autor.Rol}}</span>
							<p>{{ .Post.Autor.Biografia }}</p>
						</div>
					</div>
				</a>
			</div>

			{{ if ne (len .Recommendations) 0}}
			<h2 id="related-articles-header">Artículos recomendados</h2>
			<div id="post-related-articles">
				{{ range .Recommendations }}
				<div class="post-related-article">
					<a href="/post/{{ .Id }}">
						<img width="300" height="170" src="/static/images/{{ .Id }}.webp" alt="{{ .Alt_portada }}">
						<p class="article-author">
							{{ .Autor.Nombre }}
						</p>
						<h4 class="article-title">{{ .Titulo }}</h4>
						<div class="related-article-summary">
							{{ .Resumen | markdown }}
						</div>
					</a>
				</div>
				{{ end }}
			</div>
			{{ end }}
			<hr />
			<h2 id="comment_section_header">Comentarios</h2>
			{{ $loggedIn := .LoggedIn}}
			<section id="comment_container">
				{{- range .Comentarios }}
				{{ if $loggedIn}}
				{{ template "comentario_rep_admin" . }}
				{{ else }}
				{{ template "comentario" . }}
				{{ end }}

				{{ end }}
			</section>
			<h3 id="comment_section_publish">Publicar comentario</h3>
			{{ if $loggedIn}}
			{{ template "form_comentario_admin" }}
			{{ else }}
			{{ template "form_comentario" }}
			{{ end }}
		</div>
	</main>
	{{ template "_footer.html" }}
</body>

</html>
{{ define "comentario" }}
<div class="post_comment" id="comment-{{ .Id }}">
	<p>
		<strong>{{ .Nombre }}</strong>&nbsp;
		{{ if .Es_autor}} <img alt="Autor Vigo360" title="Autor Vigo360" src="/static/pencil-icon.svg" />{{end}}
		{{ if .Autor_original}} <img alt="Autor del artículo" title="Autor del artículo"
			src="/static/user-icon.svg" />{{end}}
		{{ with .Fecha_moderacion }} - publicado {{ date_format . "01 Feb. 15:04" }}{{ end }}
	</p>
	<div>
		{{ .Contenido | markdown }}
	</div>
	<div class="post_comment_replies">
		<details>
			<summary>Añadir respuesta</summary>
			{{ template "form_comentario" .Id }}
		</details>
		{{ range .Children }}
		{{- template "comentario" . }}
		{{ end }}
	</div>
</div>
{{ end }}

{{ define "comentario_rep_admin" }}
<div class="post_comment" id="comment-{{ .Id }}">
	<p>
		<strong>{{ .Nombre }}</strong>&nbsp;
		{{ if .Es_autor}} <img alt="Autor Vigo360" title="Autor Vigo360" src="/static/pencil-icon.svg" />{{end}}
		{{ if .Autor_original}} <img alt="Autor del artículo" title="Autor del artículo"
			src="/static/user-icon.svg" />{{end}}
		{{ with .Fecha_moderacion }} - publicado {{ date_format . "01 Feb. 15:04" }}{{ end }}
	</p>
	<div>
		{{ .Contenido | markdown }}
	</div>
	<div class="post_comment_replies">
		<details>
			<summary>Añadir respuesta</summary>
			{{ template "form_comentario_admin" .Id }}
		</details>
		{{ range .Children }}
		{{- template "comentario" . }}
		{{ end }}
	</div>
</div>
{{ end }}


{{ define "form_comentario" }}
<form method="post" class="form_comentario">
	<label for="fc_nombre">Nombre</label>
	<input type="text" id="fc_nombre" name="nombre" required>
	<label for="fc_contenido">Contenido</label>
	<textarea name="contenido" id="fc_contenido" maxlength="2000" required></textarea>
	<input type="hidden" name="padre" value="{{ . }}">
	<div class="h-captcha" data-sitekey="{{ .HcaptchaClient }}"></div>
	<p>Nota: el comentario será puesto en cola de moderación, y no será visible hasta que lo apruebe un moderador.</p>
	<button class="btn-theme" type="submit">Enviar</button>
</form>
{{ end }}

{{ define "form_comentario_admin" }}
<form method="post" class="form_comentario">
	<label for="fc_contenido">Contenido</label>
	<textarea name="contenido" id="fc_contenido" maxlength="2000" required></textarea>
	<input type="hidden" name="padre" value="{{ . }}">
	<p>El comentario se publicará inmediatamente, por tener la sesión iniciada.</p>
	<button class="btn-theme" type="submit">Enviar</button>
</form>
{{ end }}